// JavaScript Document

function initBubble(u){$(u).append('<span class="sombraH"></span><span class="sombraV"></span><span class="sombraV2"></span><span class="punta"></span>');var m=$("#ContenedorMapa").width();var q=$("#ContenedorMapa").height();var s=u.offsetLeft;var t=u.offsetTop;var p=30;var n=$(u).children("span.info").height();var o=140;var l=n+$(u).height();if((s+o+p)<=m){if((l+p)>t){var v=17;var r=17;$(u).children("span.punta").css({background:"url(http://www.bcn.cat/planol_bcn/img/bubble/punta1.png) 0 0 no-repeat",margin:v+"px 0 0 "+r+"px"});$(u).children("span.info").css({margin:(v+22)+"px 0 0 "+(r+8)+"px"});$(u).children("div#FondoDireccionActual").css({margin:(v+22)+"px 0 0 "+(r+8)+"px"});$(u).children("span.sombraH").css({"margin-top":(v+n+44)+"px","margin-left":r+"px"});$(u).children("span.sombraV").css({"margin-top":(v+34)+"px","margin-left":r+"px",height:(n+10)});$(u).children("span.sombraV2").css({"margin-top":(v+24)+"px","margin-left":r+"px"})}else{var v=-18;var r=18;$(u).children("span.punta").css({background:"url(http://www.bcn.cat/planol_bcn/img/bubble/punta3.png) 0 0 no-repeat",margin:v+"px 0 0 "+r+"px"});$(u).children("span.info").css({margin:(v-n-21)+"px 0 0 "+(r+8)+"px"});$(u).children("div#FondoDireccionActual").css({margin:(v-n-21)+"px 0 0 "+(r+8)+"px"});$(u).children("span.sombraH").css({"margin-top":(v+1)+"px","margin-left":r+"px"});$(u).children("span.sombraV").css({margin:(v-n-9)+"px 0 0 "+r+"px",height:(n+10)});$(u).children("span.sombraV2").css({"margin-top":(v-n-19)+"px","margin-left":r+"px"})}}else{if((l+p)>t){var v=18;var r=-157;$(u).children("span.punta").css({background:"url(http://www.bcn.cat/planol_bcn/img/bubble/punta2.png) 0 0 no-repeat",margin:v+"px 0 0 "+(r+122)+"px"});$(u).children("span.info").css({margin:(v+22)+"px 0 0 "+(r+8)+"px"});$(u).children("div#FondoDireccionActual").css({margin:(v+22)+"px 0 0 "+(r+8)+"px"});$(u).children("span.sombraH").css({margin:(v+n+44)+"px 0 0 "+r+"px"});$(u).children("span.sombraV").css({"margin-top":(v+34)+"px","margin-left":r+"px",height:(n+10)});$(u).children("span.sombraV2").css({"margin-top":(v+24)+"px","margin-left":r+"px"})}else{var v=-17;var r=-155;$(u).children("span.punta").css({background:"url(http://www.bcn.cat/planol_bcn/img/bubble/punta4.png) 0 0 no-repeat",margin:v+"px 0 0 "+(r+113)+"px"});$(u).children("span.info").css({margin:(v-n-21)+"px 0 0 "+(r+8)+"px"});$(u).children("div#FondoDireccionActual").css({margin:(v-n-21)+"px 0 0 "+(r+8)+"px"});$(u).children("span.sombraH").css({margin:(v+1)+"px 0 0 "+r+"px"});$(u).children("span.sombraV").css({margin:(v-n-9)+"px 0 0 "+r+"px",height:(n+10)});$(u).children("span.sombraV2").css({"margin-top":(v-n-19)+"px","margin-left":r+"px"})}}}function iconOver(b){if(!$(b).hasClass("iniciat")){initBubble(b);$(b).addClass("iniciat")}$(b).children("span").css("display","block")}function iconOut(b){$(b).children("span").css("display","none")}(function(b){b.fn.exists=function(){return this.length>0};b.fn.map_guia=function(P){if(this.length>1){MapObjects=Array();this.each(function(c){MapObjects[c]=b(this).map_guia(b.fn.map_guia.options[c])});return MapObjects}else{if(this.length==0){return false}}me=b(this);el=this;defaults={IdMap:"",ShowMapaSituacio:true,ShowDesplazamiento:true,ShowSlider:true,ShowImgEscala:true,ShowStatusCoords:true,UseHistory:true,ZoomDoubleClick:true,ZoomMouse:true,ShowPopUpLinks:true,queryEQ:"http://www.bcn.es/cgi-bin/veure_eq.pl?v=planol&id=",queryEQs:"http://w20.bcn.cat/GuiaMap/InfoEquip.aspx",DragMap:true,MapaSituacioVisible:false,queryMapa:"http://w20.bcn.cat/GuiaHandler/GuiaHandler.ashx/Guia.cca?",MapaParams:"",prevQueryMapaParams:"",prevHash:"",queryWS:"http://w20.bcn.cat/GuiaMap/JSON_Equips.aspx",centroUTMX:27601010,centroUTMY:83987710,centroGuiaX:11200000,centroGuiaY:11200000,minzoom:0,maxzoom:6,escala:[32000,16000,8000,4000,2000,1000,500,250],escala_grafica:["http://w20.bcn.cat/GuiaMap/img/escala_grafica_1.gif","http://w20.bcn.cat/GuiaMap/img/escala_grafica_2.gif","http://w20.bcn.cat/GuiaMap/img/escala_grafica_3.gif","http://w20.bcn.cat/GuiaMap/img/escala_grafica_4.gif","http://w20.bcn.cat/GuiaMap/img/escala_grafica_5.gif","http://w20.bcn.cat/GuiaMap/img/escala_grafica_6.gif","http://w20.bcn.cat/GuiaMap/img/escala_grafica_7.gif","http://w20.bcn.cat/GuiaMap/img/escala_grafica_8.gif"],iconOffset:12,WindowWidth:0,WindowHeight:0,MinWidth:800,MinHeight:500,Width:null,Height:null,ContadorTimeout:0,IsHistoryAction:false,x:"27601.010",y:"83987.710",z:"0",capas:"",plot:"",Callback_Equips:ak,Callback_Resize:function(){},Callback_PageLoad:function(){},buttonsLeft:null,buttonsRight:null};buttons={isButtonsLeft:false,isButtonsRight:false};if(P!=null){if(P.buttonsLeft!=null){buttons.isButtonsLeft=true}if(P.buttonsRight!=null){buttons.isButtonsRight=true}}var aq=b.extend(defaults,P,buttons);aq.centroUTMX=aq.x*1000;aq.centroUTMY=aq.y*1000;Mapa=b("<img />").addClass("Mapa").attr({alt:"Mapa",src:"http://w20.bcn.cat/GuiaMap/img/blanco.gif",title:""});CentroMapa=b("<img />").addClass("CentroMapa").attr({alt:"Centre mapa",src:"http://w20.bcn.cat/GuiaMap/img/cruz.gif"});Progress=b("<img />").addClass("Progress").attr({alt:"Actualizant...",src:"http://w20.bcn.cat/GuiaMap/img/loading.gif"});if(aq.ShowDesplazamiento||aq.ShowSlider||aq.isButtonsLeft){Navegacion=b("<div />").addClass("Navegacion")}if(aq.ShowDesplazamiento){Desplazamiento=b("<div />").addClass("Desplazamiento")}if(aq.ShowSlider){Slider=b("<div />").addClass("Slider");SliderBar=b("<div />").css("z-index",9).slider({orientation:"vertical",range:"min",min:aq.minzoom,max:aq.maxzoom,value:aq.z,stop:ae})}if(aq.isButtonsLeft){ButtonsLeft=b('<div id="buttonsLeft" />');b.each(aq.buttonsLeft,function(){ButtonsLeft.append(b("<img />").attr({src:"img/"+this.icon}).click(this.click))})}if(aq.isButtonsRight){ButtonsRight=b('<div id="buttonsRight" />');b.each(aq.buttonsRight,function(){icon=this.icon;hover=this.hover;ButtonsRight.append(b("<div />").css({"background-image":'url("img/'+icon+'")'}).click(this.click).mouseover(function(){b(this).css({"background-image":'url("img/'+hover+'")'})}).mouseout(function(){b(this).css({"background-image":'url("img/'+icon+'")'})}))})}if(aq.ShowMapaSituacio){MapaSituacio=b("<div />").addClass("MapaSituacio");Mapeta=b("<img />").addClass("Mapeta").attr({alt:"Mapeta de situaci??",src:"http://w20.bcn.cat/GuiaMap/img/Mapeta.gif"}).click(Z);PuntMapaSituacio=b("<img />").addClass("PuntMapaSituacio").attr({alt:"",src:"http://w20.bcn.cat/GuiaMap/img/1pxtrans.gif"}).draggable({start:function(d,c){b(this).addClass("PuntMapaSituacioCursorMove")},stop:function(c,d){ac(d);b(this).removeClass("PuntMapaSituacioCursorMove")}});ImgBotoMapaSituacio=b("<img />").addClass("ImgBotoMapaSituacio").attr({alt:"MDesplegar/replegar mapeta de situaci??",src:"http://w20.bcn.cat/GuiaMap/img/situacio_off.gif"}).click(ai)}if(aq.ShowImgEscala){EscalaGrafica=b("<div />").addClass("EscalaGrafica");ImgRosaVents=b("<img />").addClass("ImgRosaVents").attr({alt:"Rosa dels vents",src:"http://w20.bcn.cat/GuiaMap/img/rosa.png"});ImgEscala=b("<img />").addClass("ImgEscala").attr({alt:"Escala gr? fica",src:"http://w20.bcn.cat/GuiaMap/img/escala_grafica_1.gif"})}ImgCopyright=b("<img />").addClass("ImgCopyright").attr({alt:"Copyright Ajuntament de Barcelona",src:"http://w20.bcn.cat/GuiaMap/img/copyright_cat.gif"}).fancybox({type:"iframe",href:"http://www.bcn.cat/catala/copyright/",width:778,height:375,padding:0,overlayOpacity:0.8,overlayColor:"#848383",scrolling:"no",transitionIn:"elastic",transitionOut:"elastic",titleShow:false,centerOnScroll:true});CapasInfoGuia=b("<ul />").attr({id:"CapasInfoGuia"+aq.IdMap});CapasInfoUsuario=b("<ul />").attr({id:"CapasInfoUsuario"+aq.IdMap});function ah(c){if(c===""){return}else{if(c===aq.prevHash){return}aq.prevHash=c;aq.IsHistoryAction=true;T(c);aq.Callback_PageLoad(aq.capas);aq.IsHistoryAction=false}}function T(e){if((e==="")||(e===undefined)){return}var c=e.split("&");for(var d=0;d<c.length;d++){var f=c[d].charAt(0);switch(f){case"x":aq.x=c[d].substr(c[d].indexOf("=")+1);break;case"y":aq.y=c[d].substr(c[d].indexOf("=")+1);break;case"z":aq.z=c[d].substr(c[d].indexOf("=")+1);break;case"c":aq.capas=c[d].substr(c[d].indexOf("=")+1);break;case"p":aq.plot=c[d].substr(c[d].indexOf("=")+1);break}}}function ao(){CapasInfoUsuario.find("li").find("div").eq(0).each(function(){var e=b(this).attr("class");var g=e.indexOf("xy");if(g!==-1){var i=e.substr(g+2,16);var d=parseInt("0"+i.substr(0,8),10);var h=parseInt("0"+i.substr(8,8),10);if((d===aq.centroUTMX)&&(h===aq.centroUTMY)){return}var f=aj(d,h);f.x-=aq.centroGuiaX;f.y-=aq.centroGuiaY;var c=Math.round(Mapa.outerWidth()/2);var j=Math.round(Mapa.outerHeight()/2);f.x=c+Math.round(f.x/aq.escala[aq.z]);f.y=j-Math.round(f.y/aq.escala[aq.z]);b(this).css({left:(f.x-aq.iconOffset)+"px",top:(f.y-aq.iconOffset)+"px"})}})}function aj(g,i){var j=0.713643022094683,h=-0.700509555263572,e=0,d=0,f=0,c=0;e=g-aq.centroUTMX;d=i-aq.centroUTMY;f=(e*j)-(d*h);c=(d*j)+(e*h);f+=aq.centroGuiaX;c+=aq.centroGuiaY;return{x:f,y:c}}function R(k,h){var i=0.713643022094683,c=0.700509555263572,e=0,d=0,g=0,l=0,j=0,f=0;e=k-aq.centroGuiaX;d=h-aq.centroGuiaY;j=(e*i)-(d*c);f=(d*i)+(e*c);g=j+aq.centroUTMX;l=f+aq.centroUTMY;return{x:g,y:l}}function X(){var e=me.outerWidth();var d=me.outerHeight();aq.centroUTMX=aq.x*1000;aq.centroUTMY=aq.y*1000;aq.queryMapaParams="x="+aq.x;aq.queryMapaParams+="&y="+aq.y;aq.queryMapaParams+="&z="+aq.z;if(aq.capas!==""){aq.queryMapaParams+="&c="+aq.capas}aq.queryMapaParams+="&w="+(e-4);aq.queryMapaParams+="&h="+(d-4);if(aq.plot!==""){aq.queryMapaParams+="&p="+aq.plot}if(aq.queryMapaParams===aq.prevQueryMapaParams){return}if((aq.UseHistory)&&(!aq.IsHistoryAction)){b.history.load(aq.queryMapaParams)}aq.prevQueryMapaParams=aq.queryMapaParams;ag();CapasInfoGuia.html("");if(aq.capas!==""){var c="CodiCapa="+aq.capas+"&ImgWidth="+e+"&ImgHeight="+d+"&Zoom="+aq.z+"&CentroX="+Math.round(aq.centroUTMX)+"&CentroY="+Math.round(aq.centroUTMY)+"&Idioma=0";b.ajax({type:"POST",url:aq.queryWS,data:c,dataType:"jsonp",beforeSend:function(){if(Progress.css("display")!="inline"){Progress.show()}if(Mapa.hasClass("MapaCursorMove")){Mapa.removeClass("MapaCursorMove")}if(!Mapa.hasClass("MapaCursorWait")){Mapa.addClass("MapaCursorWait")}window.status="Procesant dades..."},error:function(){Progress.hide();/*alert("Servei no disponible, provi m??s tard.")*/},success:function(f){aq.Callback_Equips(f,aq.iconOffset,aq.z)},complete:function(){Progress.hide()}})}else{Progress.hide()}if(Mapa.hasClass("MapaCursorWait")){Mapa.removeClass("MapaCursorWait")}if(aq.ShowMapaSituacio){au(aq.centroUTMX,aq.centroUTMY,e,d)}}function ak(v,n,f){var q,t,h,g,p,m=-100,e=-100,u=null,x="",y="",w,i=function(){iconOver(this);return false},l=function(){iconOut(this);return false};window.status="Procesant dades...";b("#CapasInfoGuia").html("");if(f>4){w=n}else{w=Math.round(n*0.666)}for(var c=0;c<v.length;c++){var z,r,j,k;q=v[c].C;t=v[c].N;h=v[c].X;g=v[c].Y;p=v[c].Id;t=t.replace(/ #/,"");var s=v[c].NC;if((h!==m)||(g!==e)){z=document.createElement("li");r=document.createElement("a");j=document.createElement("span");k="";b(j).addClass("info");if(p.indexOf("ASIA")>=0){k=aq.queryEQ+p.substr(p.indexOf("ASIA")+4)+"&idioma="+b("html").attr("lang")}else{if(p.indexOf("OBRA")>=0){k=queryOB+p.substr(p.indexOf("OBRA")+4)+"&idioma="+b("html").attr("lang")}else{if(p.indexOf("URL")>=0){k=p.substr(p.indexOf("URL")+3)}else{k=aq.queryEQs+"?idioma="+b("html").attr("lang")+"&ID="+p}}}if(t.match(/<br>/i)){t=t.replace(/<br>/i,"</strong><br>")}else{t=t+"</strong>"}t="<i>"+s+"</i><br><strong>"+t;j.innerHTML=t;r.appendChild(j);z.appendChild(r);b("#CapasInfoGuia").append(z);r.onmouseover=i;r.onmouseout=l;u=j;x=q;y=p}else{var d=u.innerHTML+"<hr>";t="<strong>"+t;if(t.match(/<br>/i)){t=t.replace(/<br>/i,"</strong><br>")}else{t=t+"</strong>"}if(q!==x){t="<i>"+s+"</i><br>"+t;x=q}u.innerHTML=d+t;y=y+";"+p}if(y.indexOf(";")>0){k=aq.queryEQs+"?idioma="+b("html").attr("lang")+"&ID="+y;r.setAttribute("href","")}r.setAttribute("href",k);r.setAttribute("id",p);r.style.position="absolute";r.style.left=(h-w)+"px";r.style.top=(g-w)+"px";r.style.width=(w*2)+"px";r.style.height=(w*2)+"px";r.style.zindex=5;m=h;e=g}b("#CapasInfoGuia A").mouseover(function(){iconOver(this)}).mouseout(function(){iconOut(this)});b("#CapasInfoGuia A").addClass("LinkEquips").css("cursor","pointer");if(aq.ShowPopUpLinks){b("#CapasInfoGuia A").fancybox({type:"iframe",autoDimensions:false,width:680,height:500,padding:0,overlayOpacity:0.8,overlayColor:"#848383",transitionIn:"elastic",transitionOut:"elastic",titleShow:false,centerOnScroll:true})}else{b("#CapasInfoGuia A").attr("target","_blank")}window.status="Proc??s acabat."}function U(m){b(m).append('<span class="sombraH"></span><span class="sombraV"></span><span class="sombraV2"></span><span class="punta"></span>');var e=b(m).parents(".ContenedorMapa").width();var i=b(m).parents(".ContenedorMapa").height();var k=m.offsetLeft;var l=m.offsetTop;var h=30;var f=b(m).children("span.info").height();var g=140;var d=f+b(m).height();if((k+g+h)<=e){if((d+h)>l){var c=17;var j=17;b(m).children("span.punta").css({background:"url(http://www.bcn.cat/planol_bcn/img/bubble/punta1.png) 0 0 no-repeat",margin:c+"px 0 0 "+j+"px"});b(m).children("span.info").css({margin:(c+22)+"px 0 0 "+(j+8)+"px"});b(m).children("div#FondoDireccionActual").css({margin:(c+22)+"px 0 0 "+(j+8)+"px"});b(m).children("span.sombraH").css({"margin-top":(c+f+44)+"px","margin-left":j+"px"});b(m).children("span.sombraV").css({"margin-top":(c+34)+"px","margin-left":j+"px",height:(f+10)});b(m).children("span.sombraV2").css({"margin-top":(c+24)+"px","margin-left":j+"px"})}else{var c=-18;var j=18;b(m).children("span.punta").css({background:"url(http://www.bcn.cat/planol_bcn/img/bubble/punta3.png) 0 0 no-repeat",margin:c+"px 0 0 "+j+"px"});b(m).children("span.info").css({margin:(c-f-21)+"px 0 0 "+(j+8)+"px"});b(m).children("div#FondoDireccionActual").css({margin:(c-f-21)+"px 0 0 "+(j+8)+"px"});b(m).children("span.sombraH").css({"margin-top":(c+1)+"px","margin-left":j+"px"});b(m).children("span.sombraV").css({margin:(c-f-9)+"px 0 0 "+j+"px",height:(f+10)});b(m).children("span.sombraV2").css({"margin-top":(c-f-19)+"px","margin-left":j+"px"})}}else{if((d+h)>l){var c=18;var j=-157;b(m).children("span.punta").css({background:"url(http://www.bcn.cat/planol_bcn/img/bubble/punta2.png) 0 0 no-repeat",margin:c+"px 0 0 "+(j+122)+"px"});b(m).children("span.info").css({margin:(c+22)+"px 0 0 "+(j+8)+"px"});b(m).children("div#FondoDireccionActual").css({margin:(c+22)+"px 0 0 "+(j+8)+"px"});b(m).children("span.sombraH").css({margin:(c+f+44)+"px 0 0 "+j+"px"});b(m).children("span.sombraV").css({"margin-top":(c+34)+"px","margin-left":j+"px",height:(f+10)});b(m).children("span.sombraV2").css({"margin-top":(c+24)+"px","margin-left":j+"px"})}else{var c=-17;var j=-155;b(m).children("span.punta").css({background:"url(http://www.bcn.cat/planol_bcn/img/bubble/punta4.png) 0 0 no-repeat",margin:c+"px 0 0 "+(j+113)+"px"});b(m).children("span.info").css({margin:(c-f-21)+"px 0 0 "+(j+8)+"px"});b(m).children("div#FondoDireccionActual").css({margin:(c-f-21)+"px 0 0 "+(j+8)+"px"});b(m).children("span.sombraH").css({margin:(c+1)+"px 0 0 "+j+"px"});b(m).children("span.sombraV").css({margin:(c-f-9)+"px 0 0 "+j+"px",height:(f+10)});b(m).children("span.sombraV2").css({"margin-top":(c-f-19)+"px","margin-left":j+"px"})}}b(m).pngFix()}function af(){if(aq.Height!=null){height_tmp=aq.Height}else{height_tmp=b(window).height()-me.parents("div").offset().top;parentsel=me.parent("div");while(parentsel.exists()){if(parentsel.is(":visible")){height_tmp-=V(parentsel.css("marginBottom"));height_tmp-=V(parentsel.css("paddingBottom"))}parentsel=parentsel.parent("div")}height_tmp-=V(me.css("borderBottomWidth"));parentsel=me.parent("div");while(parentsel.exists()){parentsel2=parentsel.next("div");while(parentsel2.exists()){if(parentsel2.is(":visible")){height_tmp-=parentsel2.outerHeight()}parentsel2=parentsel2.next("div")}parentsel=parentsel.parent("div")}}return height_tmp}function Y(){if(aq.Width!=null){width_tmp=aq.Width}else{width_tmp=b(window).width()-me.offset().left;parentsel=me.parent("div");while(parentsel.exists()){if(parentsel.is(":visible")){width_tmp-=V(parentsel.css("marginRight"));width_tmp-=V(parentsel.css("paddingRight"))}parentsel=parentsel.parent("div")}width_tmp+=V(me.css("borderRightWidth"))}return width_tmp}function V(c){value_extract=parseInt(c);if(isNaN(value_extract)){value_extract=0}return value_extract}function a(e,g){aq.Callback_Resize(g);me.height(g-1);if(aq.Width!=null){me.width(e-1)}var c=V(CentroMapa.css("left"));var d=V(CentroMapa.css("top"));CentroMapa.css({left:Math.round((me.outerWidth()/2)-(CentroMapa.outerWidth()/2))+"px",top:Math.round((me.outerHeight()/2)-(CentroMapa.outerHeight()/2))+"px"});Progress.css({left:Math.round((me.outerWidth()/2)-(Progress.outerWidth()/2))+"px",top:Math.round((me.outerHeight()/2)-(Progress.outerHeight()/2))+"px"});if(aq.ShowMapaSituacio){ap()}X();var f=((aq.WindowWidth-e)/2);var h=((aq.WindowHeight-g)/2);S(f,h)}function S(d,c){CapasInfoUsuario.find("li").find("div:eq(0)").each(function(){var e=V(b(this).css("left"))-d+0.3;var f=V(b(this).css("top"))-c+0.5;b(this).css({left:e+"px",top:f+"px"})})}function ag(){var d=aq.queryMapa+aq.queryMapaParams,c=V(Mapa.css("left"),10),e=V(Mapa.css("top"),10);if((c===1)&&(e===1)){Mapa.attr("src",d)}else{if(!Mapa.hasClass("MapaCursorWait")){Mapa.addClass("MapaCursorWait")}Mapa.after(b("<img />").css({width:Mapa.width(),height:Mapa.height(),position:"absolute",cursor:"wait",left:"1px",top:"1px",overflow:"hidden"}).attr({id:"TmpImg"+aq.IdMap,alt:"Mapa",title:"",src:d}).show());me.find("#TmpImg"+aq.IdMap).load(function(){Mapa.attr("src",d)});Mapa.load(function(){b(this).css({left:"1px",top:"1px"});me.find("#TmpImg"+aq.IdMap).remove()})}if(aq.ShowImgEscala){ImgEscala.attr("src",aq.escala_grafica[aq.z])}}function W(){CapasInfoGuia.hide();CapasInfoUsuario.hide()}function M(){CapasInfoGuia.show();CapasInfoUsuario.show()}function an(e,d){var c;if((e!==0)||(d!==0)){e*=aq.escala[aq.z];d*=aq.escala[aq.z];guiaX=aq.centroGuiaX-e;guiaY=aq.centroGuiaY+d;c=R(guiaX,guiaY);aq.centroGuiaX=guiaX;aq.centroGuiaY=guiaY;aq.centroUTMX=c.x;aq.centroUTMY=c.y;aq.x=Math.round(c.x/1000);aq.y=Math.round(c.y/1000);UTMX=c.x;UTMY=c.y;ao();X()}M();return false}function ar(){if(aq.z<aq.maxzoom){aq.z++}aq.centroUTMX=UTMX;aq.centroUTMY=UTMY;aq.centroGuiaX=guiaX;aq.centroGuiaY=guiaY;aq.x=UTMX/1000;aq.y=UTMY/1000;Q();aa(UTMX,UTMY);return true}function O(e){var g,h,f,d,c;if(e){g=e.target;imgX=e.pageX;imgY=e.pageY;imgX=imgX-g.offsetLeft;imgY=imgY-g.offsetTop;d=g.offsetParent;while(d!==null){imgX-=d.offsetLeft;imgY-=d.offsetTop;d=d.offsetParent}}else{g=event.srcElement;imgX=event.x;imgY=event.y}h=g.width;f=g.height;imgX=imgX-g.border;imgY=imgY-g.border;mouseX=imgX-(h/2);mouseY=-(imgY-(f/2));guiaX=aq.centroGuiaX+(mouseX*aq.escala[aq.z]);guiaY=aq.centroGuiaY+(mouseY*aq.escala[aq.z]);guiaX=Math.round(guiaX);guiaY=Math.round(guiaY);c=R(guiaX,guiaY);UTMX=Math.round(c.x);UTMY=Math.round(c.y);aa(UTMX,UTMY);return true}function aa(g,h){var f=(g/1000)+400000;var e=(h/1000)+4500000;var d=at(f,e);var c="("+imgX+","+imgY+") Coords. UTM ED50: (H31) "+f.toFixed(2)+","+e.toFixed(2);c+=" - Geo: "+d;window.status=c}function at(aJ,A){var f,C,K,F,B,s,ay,q,p,J,i,t,y,z,ax,az,aG,g,G,k,H,L,j,I,aI,aH,h,D,u;var d,av,e;var m="",w="";var x=0,E=0,r=-131.250417839,aw=-206.9696618318,l=(1.321908127/1000000),c=(-1.6446198/3600)*Math.PI/180,n=Math.sin(c),v=Math.cos(c);x=r+((1+l)*((aJ*v)-(A*n)));E=aw+((1+l)*((aJ*n)+(A*v)));f=6378137;C=6356752.31414035;K=(Math.pow((Math.pow(f,2)-Math.pow(C,2)),0.5))/(C);F=Math.pow(K,2);B=Math.pow(f,2)/C;L=x-500000;j=E;q=(31*6)-183;ay=j/(6366197.724*0.9996);t=B*0.9996/Math.pow((1+F*Math.pow(Math.cos(ay),2)),0.5);f=L/t;z=Math.sin(2*ay);ax=z*Math.pow(Math.cos(ay),2);az=ay+(z/2);aG=((3*az)+ax)/4;g=((5*aG)+ax*Math.pow(Math.cos(ay),2))/3;s=3*F/4;G=5*Math.pow(s,2)/3;k=35*Math.pow(s,3)/27;H=0.9996*B*(ay-s*az+G*aG-k*g);C=(j-H)/t;y=(F*Math.pow(f,2)*Math.pow(Math.cos(ay),2))/2;J=f*(1-(y/3));i=C*(1-y)+ay;I=Math.exp(1);aI=(Math.pow(I,J)-Math.pow(I,-J))/2;p=Math.atan(aI/Math.cos(i));aH=Math.atan(Math.cos(p)*Math.tan(i));D=((p/Math.PI)*180)+q;h=ay+(((1+(F*Math.pow(Math.cos(ay),2))-(3/2*F*Math.sin(ay)*Math.cos(ay)*(aH-ay))))*(aH-ay));u=(h/Math.PI)*180;d=Math.floor(D);av=Math.floor((D-d)*60);e=(((D-d)*60)-av)*60;m=d+"?? "+av+"' "+e.toFixed(4)+'" E';d=Math.floor(u);av=Math.floor((u-d)*60);e=(((u-d)*60)-av)*60;w=d+"?? "+av+"' "+e.toFixed(4)+'" N';return w+", "+m}function am(c){if(c>0){if(aq.z<aq.maxzoom){aq.z++;Q()}}else{if(aq.z>aq.minzoom){aq.z--;Q()}}}function Q(){Progress.show();if(!Mapa.hasClass("MapaCursorWait")){Mapa.addClass("MapaCursorWait")}if(aq.ShowSlider){SliderBar.slider("value",aq.z)}ad()}function al(e){if(me.find("#TmpImg"+aq.IdMap).exists()){return}Progress.show();if(!Mapa.hasClass("MapaCursorWait")){Mapa.addClass("MapaCursorWait")}var i=me.outerWidth();var k=me.outerHeight();var c=i*aq.escala[aq.z];var h=k*aq.escala[aq.z];var g=aj(aq.x*1000,aq.y*1000);var j=0,d=0;W();switch(e){case"up":g.y+=Math.round(h/2);d+=Math.round(k/2);break;case"down":g.y-=Math.round(h/2);d-=Math.round(k/2);break;case"left":g.x-=Math.round(c/2);j+=Math.round(i/2);break;case"right":g.x+=Math.round(c/2);j-=Math.round(i/2);break}var f=R(g.x,g.y);aq.centroGuiaX=g.x;aq.centroGuiaY=g.y;aq.centroUTMX=f.x;aq.centroUTMY=f.y;UTMX=Math.round(f.x);UTMY=Math.round(f.y);aq.x=Math.round(UTMX/1000);aq.y=Math.round(UTMY/1000);if(aq.ShowMapaSituacio){au(aq.centroUTMX,aq.centroUTMY,i,k)}Mapa.animate({left:"+="+j,top:"+="+d},250,function(){X();M()})}function ae(d,c){if(aq.IsHistoryAction){return}Progress.show();if(!Mapa.hasClass("MapaCursorWait")){Mapa.addClass("MapaCursorWait")}aq.z=c.value;ad()}function ad(){aq.ContadorTimeout++;setTimeout(o,200)}function o(){aq.ContadorTimeout--;if(aq.ContadorTimeout===0){X();ao()}}function ap(){ButtonsTop=0;if(aq.isButtonsRight){ButtonsTop=aq.buttonsRight.length*25}if(MapaSituacio.hasClass("visible")){MapaSituacio.css({top:(ButtonsTop+9)+"px",width:"200px",height:"150px",zindex:10,border:"1px solid",backgroundImage:"url(http://w20.bcn.cat/GuiaMap/img/Mapeta.gif)"});Mapeta.show();ImgBotoMapaSituacio.css({top:"124px",cursor:"pointer"}).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_on.gif").mouseover(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_on_2.gif")}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_on.gif")})}else{MapaSituacio.css({top:(ButtonsTop+9)+"px",width:"26px",height:"26px",border:"none",backgroundImage:"none"});Mapeta.hide();ImgBotoMapaSituacio.css({top:0,cursor:"pointer"}).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_off.gif").mouseover(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_off_2.gif")}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_off.gif")})}}function ai(){if(MapaSituacio.hasClass("visible")){PuntMapaSituacio.hide();Mapeta.hide();ImgBotoMapaSituacio.mouseover(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_off_2.gif")}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_off.gif")}).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_off.gif");MapaSituacio.animate({width:"26px",height:"26px"},500,function(){ImgBotoMapaSituacio.css("top",0);b(this).css({backgroundImage:"none",border:"none"})}).removeClass("visible");N("Mapeta","",-1)}else{PuntMapaSituacio.show();Mapeta.show();ImgBotoMapaSituacio.css("top","124px").mouseover(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_on_2.gif")}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_on.gif")}).attr("src","http://w20.bcn.cat/GuiaMap/img/situacio_on.gif");MapaSituacio.css({border:"1px solid",backgroundImage:"url(http://w20.bcn.cat/GuiaMap/img/Mapeta.gif)",backgroundPosition:"left top"}).animate({width:"200px",height:"150px"},500).addClass("visible");N("Mapeta",true,365)}MapaSituacio.pngFix()}function N(f,c,d){if(d){var g=new Date();g.setTime(g.getTime()+(d*24*60*60*1000));var e="; expires="+g.toGMTString()}else{e=""}document.cookie=f+"="+c+e+"; path=/"}function au(d,f,h,i){var c=27601103,g=83987710,e=0,m=0,k,p,j=-0.700509,l=0.713643,q,n;h*=aq.escala[aq.z];i*=aq.escala[aq.z];h/=128000;i/=128000;k=(d-c)/128000;p=(f-g)/128000;e=(k*l)-(p*j);m=(p*l)+(k*j);e+=100;m=150-(m+75);e-=2;m-=2;q=Math.round(e-(h/2));n=Math.round(m-(i/2));PuntMapaSituacio.css({left:q+"px",top:n+"px",width:h+"px",height:i+"px"})}function ac(g){var f=g.position.left;var c=g.position.top;var e=Math.round(PuntMapaSituacio.outerWidth()/2);var d=Math.round(PuntMapaSituacio.outerHeight()/2);f+=e;c+=d;ab(f,c)}function Z(e){var d=e.pageX-Mapeta.parents().offset().left;var c=e.pageY-Mapeta.parents().offset().top;ab(d,c)}function ab(f,i){var c=27601103,d=83987710,h,j,e=0.700509,g=0.713643;f-=100;i=150-(i+75);h=(f*g)-(i*e);j=(i*g)+(f*e);h*=128000;j*=128000;h+=c;j+=d;aq.x=h/1000;aq.y=j/1000;aq.centroUTMX=aq.x;aq.centroUTMY=aq.y;Progress.show();X()}el.build=function(){if(aq.UseHistory){b.history.init(ah)}if(aq.DragMap){Mapa.addClass("MapaMove").draggable({start:function(d,c){CentroMapa.show();if(!b(this).hasClass("MapaCursorMove")){b(this).addClass("MapaCursorMove")}},drag:W,stop:function(f,e){var c,d;CentroMapa.hide();c=V(b(this).css("left"),10);d=V(b(this).css("top"),10);Progress.show();if(b(this).hasClass("MapaCursorMove")){b(this).removeClass("MapaCursorMove")}if(!b(this).hasClass("MapaCursorWait")){b(this).addClass("MapaCursorWait")}an(c,d)}})}if(aq.ZoomDoubleClick){Mapa.dblclick(ar)}if(aq.ShowStatusCoords){Mapa.mousemove(function(c){O(c)})}if(aq.ZoomMouse){Mapa.mousewheel(function(c,d){am(d)})}if(aq.ShowDesplazamiento){Desplazamiento.append(b("<img />").attr({alt:"Despla??ar centre del mapa",src:"http://w20.bcn.cat/GuiaMap/img/moviment_bg.png",height:"73",width:"70"})).append(b("<img />").addClass("MoveUp").attr({alt:"Despla??ar centre del mapa cap a dalt",src:"http://w20.bcn.cat/GuiaMap/img/arrow_up.gif"}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/arrow_up.gif")}).mouseover(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/arrow_up2.gif")}).click(function(){setTimeout(function(){al("up")},500)})).append(b("<img />").addClass("MoveLeft").attr({alt:"Despla??ar centre del mapa cap a l'esquerra",src:"http://w20.bcn.cat/GuiaMap/img/arrow_left.gif"}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/arrow_left.gif")}).mouseover(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/arrow_left2.gif")}).click(function(){setTimeout(function(){al("left")},500)})).append(b("<img />").addClass("MoveRight").attr({alt:"Despla??ar centre del mapa cap a la dreta",src:"http://w20.bcn.cat/GuiaMap/img/arrow_right.gif"}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/arrow_right.gif")}).mouseover(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/arrow_right2.gif")}).click(function(){setTimeout(function(){al("right")},500)})).append(b("<img />").addClass("MoveDown").attr({alt:"Despla??ar centre del mapa cap a baix",src:"http://w20.bcn.cat/GuiaMap/img/arrow_down.gif"}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/arrow_down.gif")}).mouseover(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/arrow_down2.gif")}).click(function(){setTimeout(function(){al("down")},500)}))}if(aq.ShowSlider){Slider.append(b("<img />").attr({id:"sliderbg"+aq.IdMap,alt:"Engrandir l'escala del mapa",src:"http://w20.bcn.cat/GuiaMap/img/bg_escale.png",height:"164",width:"24"})).append(b("<img />").addClass("sliderUp").attr({alt:"",src:"http://w20.bcn.cat/GuiaMap/img/SliderUp1.gif",height:"24",width:"24"}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/SliderUp1.gif")}).mouseover(function(){if(aq.z<aq.maxzoom){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/SliderUp2.gif")}}).click(function(){if(aq.z<aq.maxzoom){aq.z++;Q();if(aq.z===aq.maxzoom){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/SliderUp1.gif")}}})).append(SliderBar).append(b("<img />").addClass("sliderDown").attr({alt:"Redu??r l'escala del mapa",alt:"",src:"http://w20.bcn.cat/GuiaMap/img/SliderDown1.gif",height:"24",width:"24"}).mouseout(function(){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/SliderDown1.gif")}).mouseover(function(){if(aq.z>aq.minzoom){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/SliderDown2.gif")}}).click(function(){if(aq.z>aq.minzoom){aq.z--;Q();if(aq.z===aq.minzoom){b(this).attr("src","http://w20.bcn.cat/GuiaMap/img/SliderDown1.gif")}}}))}if(aq.ShowDesplazamiento){Navegacion.append(Desplazamiento)}else{if(aq.ShowSlider){Slider.children("img:eq(1)").css("top","4px");SliderBar.css("top","46px");Slider.children("img:eq(2)").css("top","145px")}}if(aq.ShowSlider){Navegacion.append(Slider)}if(aq.isButtonsLeft){Navegacion.append(ButtonsLeft)}if(aq.ShowMapaSituacio){MapaSituacio.append(Mapeta).append(PuntMapaSituacio).append(ImgBotoMapaSituacio);if(aq.MapaSituacioVisible){PuntMapaSituacio.show();MapaSituacio.addClass("visible")}}if(aq.ShowImgEscala){EscalaGrafica.append(ImgRosaVents).append(ImgEscala)}ImageMap=b("<div />").attr({id:"ImageMap"+aq.IdMap}).addClass("ImageMap").append(CapasInfoGuia).append(CapasInfoUsuario);me.attr({"class":"ContenedorMapa"}).append(Mapa).append(CentroMapa).append(Progress);if(aq.ShowDesplazamiento||aq.ShowSlider||aq.isButtonsLeft){me.append(Navegacion)}if(aq.isButtonsRight){me.append(ButtonsRight)}if(aq.ShowMapaSituacio){me.append(MapaSituacio)}if(aq.ShowImgEscala){me.append(EscalaGrafica)}me.append(ImgCopyright).append(ImageMap);Mapa.removeAttr("width").removeAttr("height");if(aq.ShowSlider){Q()}el.WResize();b(window).resize(el.WResize);return this};el.WResize=function(){var d=Y();var c=af();if((d!==aq.WindowWidth)||(c!==aq.WindowHeight)){a(d,c)}aq.WindowWidth=d;aq.WindowHeight=c};el.Resize=function(d,c){me.width(d-1);me.height(c-1);X()};el.PonCapa=function(c){if(aq.capas.indexOf(c)!==-1){return}else{aq.capas+=c}};el.QuitaCapa=function(c){if(aq.capas.indexOf(c)===-1){return}else{aq.capas=aq.capas.replace(c,"")}};el.onCapaTimeout=function(){aq.ContadorTimeout--;if(aq.ContadorTimeout===0){X()}};el.addContadorTimeout=function(){aq.ContadorTimeout++};el.iconOver=function(c){if(!b(c).hasClass("iniciat")){U(c);b(c).addClass("iniciat")}b(c).children("span").css("display","block")};el.iconOut=function(c){b(c).children("span").css("display","none")};el.setDefaults=function(){aq.centroUTMX=27601010;aq.centroUTMY=83987710;aq.centroGuiaX=11200000;aq.centroGuiaY=11200000;aq.x="27601.010";aq.y="83987.710";aq.z="0";aq.capas="";aq.plot="";Q()};el.setCentroUTMX=function(c){aq.centroUTMX=c;aq.x=aq.centroUTMX/1000};el.setCentroUTMY=function(c){aq.centroUTMY=c;aq.y=aq.centroUTMY/1000};el.setXY=function(c,d){aq.x=c;aq.y=d};el.setPlot=function(){aq.plot=aq.x+","+aq.y;aq.z=5;Q()};el.setWait=function(){if(Mapa.hasClass("MapaCursorMove")){Mapa.removeClass("MapaCursorMove")}if(!Mapa.hasClass("MapaCursorWait")){Mapa.addClass("MapaCursorWait")}};el.setMove=function(){Mapa.addClass("MapaMove")};el.removeCapas=function(){aq.capas="";X()};el.getXYZ=function(){return aq.x+"|"+aq.y+"|"+aq.z};el.getParams=function(){var c="#x="+aq.x;c+="&y="+aq.y;c+="&z="+aq.z;if(aq.capas!==""){c+="&c="+aq.capas}c+="&w="+(me.outerWidth()-4);c+="&h="+(me.outerHeight()-4);if(aq.plot!==""){c+="&p="+aq.plot}return c};el.getCapas=function(){return aq.capas};el.setCapas=function(c){aq.capas=c;X()};el.getIconOffset=function(){return aq.iconOffset};el.getOuter=function(){return{width:Mapa.outerWidth(),height:Mapa.outerHeight()}};return el.build()}})(jQuery);